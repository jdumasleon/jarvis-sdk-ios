name: ðŸ” PR Checks

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write
  checks: write
  security-events: write
  actions: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  validate:
    name: ðŸŽ¯ Validate PR
    runs-on: macos-latest

    steps:
      - name: ðŸ—ï¸ Checkout
        uses: actions/checkout@v4

      - name: ðŸ” Validate PR Title
        run: |
          PR_TITLE="${{ github.event.pull_request.title }}"
          echo "PR Title: $PR_TITLE"

          # Check if title starts with version bump indicator
          if [[ "$PR_TITLE" =~ ^(MAJOR|MINOR|PATCH) ]]; then
            echo "âœ… PR title has valid version bump prefix"
          else
            echo "â„¹ï¸  PR title doesn't specify version bump (MAJOR|MINOR|PATCH). Will default to PATCH on merge."
          fi

  build:
    name: ðŸ—ï¸ Build & Test
    runs-on: macos-latest

    steps:
      - name: ðŸ—ï¸ Checkout
        uses: actions/checkout@v4

      - name: ðŸ“¦ Cache Swift Package Manager
        uses: actions/cache@v4
        with:
          path: |
            .build
            ~/Library/Caches/org.swift.swiftpm
          key: ${{ runner.os }}-spm-${{ hashFiles('**/Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-spm-

      - name: ðŸ” Run SwiftLint
        if: false  # Enable when SwiftLint config is added
        run: |
          if which swiftlint >/dev/null; then
            swiftlint --strict
          else
            echo "âš ï¸  SwiftLint not installed, skipping"
          fi

      - name: ðŸ” Run SwiftFormat Check
        if: false  # Enable when SwiftFormat config is added
        run: |
          if which swiftformat >/dev/null; then
            swiftformat --lint JarvisSDK/Sources
          else
            echo "âš ï¸  SwiftFormat not installed, skipping"
          fi

      - name: ðŸ§ª Run Tests
        run: |
          cd JarvisSDK
          swift test --enable-code-coverage

      - name: ðŸ“‹ Generate Code Coverage
        run: |
          cd JarvisSDK
          xcrun llvm-cov export \
            -format="lcov" \
            -instr-profile=.build/debug/codecov/default.profdata \
            .build/debug/*.xctest/Contents/MacOS/* > coverage.lcov || true

      - name: ðŸ“Š Upload Coverage
        uses: codecov/codecov-action@v4
        if: always()
        continue-on-error: true
        with:
          files: ./JarvisSDK/coverage.lcov
          flags: unittests
          name: jarvis-ios-sdk
          fail_ci_if_error: false

      - name: ðŸ—ï¸ Build SDK (Debug)
        run: |
          cd JarvisSDK
          swift build -c debug

      - name: ðŸ—ï¸ Build SDK (Release)
        run: |
          cd JarvisSDK
          swift build -c release

      - name: ðŸ—ï¸ Build Demo App
        if: false  # Enable when demo app is ready
        run: |
          cd JarvisDemo
          xcodebuild \
            -scheme JarvisDemo \
            -configuration Debug \
            -destination 'platform=iOS Simulator,name=iPhone 15 Pro' \
            -derivedDataPath build \
            build

      - name: ðŸ“¦ Build XCFramework
        run: |
          cd JarvisSDK

          # Build for iOS devices
          xcodebuild archive \
            -scheme Jarvis \
            -configuration Release \
            -destination 'generic/platform=iOS' \
            -archivePath './build/ios.xcarchive' \
            SKIP_INSTALL=NO \
            BUILD_LIBRARY_FOR_DISTRIBUTION=YES

          # Build for iOS Simulator
          xcodebuild archive \
            -scheme Jarvis \
            -configuration Release \
            -destination 'generic/platform=iOS Simulator' \
            -archivePath './build/ios-simulator.xcarchive' \
            SKIP_INSTALL=NO \
            BUILD_LIBRARY_FOR_DISTRIBUTION=YES

          # Create XCFramework
          xcodebuild -create-xcframework \
            -framework './build/ios.xcarchive/Products/Library/Frameworks/Jarvis.framework' \
            -framework './build/ios-simulator.xcarchive/Products/Library/Frameworks/Jarvis.framework' \
            -output './build/Jarvis.xcframework'

      - name: ðŸ“¤ Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: |
            JarvisSDK/build/Jarvis.xcframework
            JarvisSDK/.build/release/
          retention-days: 7

  codeql:
    name: ðŸ”’ CodeQL
    runs-on: macos-latest
    permissions:
      security-events: write
      contents: read
      actions: read
    steps:
      - name: ðŸ—ï¸ Checkout
        uses: actions/checkout@v4

      - name: ðŸ”§ Init CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: swift

      - name: ðŸ—ï¸ Custom Build
        run: |
          cd JarvisSDK
          swift build -c debug

      - name: ðŸ“ˆ Analyze (uploads SARIF)
        uses: github/codeql-action/analyze@v3

  preview:
    name: ðŸ“± Preview Build
    needs: build
    runs-on: macos-latest
    if: github.event.action == 'opened' || github.event.action == 'synchronize'

    steps:
      - name: ðŸ’¬ Comment PR with Preview
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.issue.number;
            const runId = context.runId;
            const repository = context.repo;

            const comment = `## ðŸ“± Preview Build Ready!

            Your PR build is complete and ready for testing:

            ### ðŸš€ Download Links
            - [ðŸ“¦ XCFramework](https://github.com/${repository.owner}/${repository.repo}/actions/runs/${runId})
            - [ðŸ”¨ Debug Build](https://github.com/${repository.owner}/${repository.repo}/actions/runs/${runId})
            - [ðŸš€ Release Build](https://github.com/${repository.owner}/${repository.repo}/actions/runs/${runId})

            ### ðŸ” Build Status
            - âœ… SwiftLint checks passed (if enabled)
            - âœ… Unit tests passed
            - âœ… Build successful
            - âœ… XCFramework created

            ### ðŸ“¦ Installation

            #### Swift Package Manager
            \`\`\`swift
            .package(url: "https://github.com/${repository.owner}/${repository.repo}", branch: "${context.payload.pull_request.head.ref}")
            \`\`\`

            #### CocoaPods
            \`\`\`ruby
            pod 'JarvisSDK', :git => 'https://github.com/${repository.owner}/${repository.repo}', :branch => '${context.payload.pull_request.head.ref}'
            \`\`\`

            ### ðŸŽ¯ What's Changed
            This build includes the changes from commit: \`${context.sha.substring(0, 7)}\`

            ---
            *This comment will be updated automatically on new commits.*`;

            // Try to find existing comment
            const comments = await github.rest.issues.listComments({
              owner: repository.owner,
              repo: repository.repo,
              issue_number: prNumber
            });

            const existingComment = comments.data.find(comment =>
              comment.body.includes('## ðŸ“± Preview Build Ready!')
            );

            if (existingComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: repository.owner,
                repo: repository.repo,
                comment_id: existingComment.id,
                body: comment
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: repository.owner,
                repo: repository.repo,
                issue_number: prNumber,
                body: comment
              });
            }
